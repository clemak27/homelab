---
version: '3.8'

services:
  prometheus:
    image: ${PROMETHEUS_SERVICE_IMAGE:?}:${PROMETHEUS_SERVICE_VERSION:?}
    container_name: ${PROMETHEUS_SERVICE_NAME:?}
    ports:
      - "${PROMETHEUS_SERVICE_PORT:?}:${PROMETHEUS_SERVICE_PORT:?}"
    volumes:
      - "${DOCKER_DATA:?}/${PROMETHEUS_SERVICE_NAME:?}/data:/prometheus"
      - "${DOCKER_DATA:?}/${PROMETHEUS_SERVICE_NAME:?}/config:/config"
      - "${SERVICES_DIR:?}/monitoring/prometheus_config.yaml:/config/config.yml:ro"
    security_opt:
      - "label:disable"
    networks:
      - private
    command:
      - "--config.file=/config/config.yml"
    labels:
      traefik.enable: true
      traefik.http.routers.prometheus-router.entrypoints: https
      traefik.http.routers.prometheus-router.rule: Host(`${PROMETHEUS_SERVICE_NAME:?}.${DOMAIN:?}`)
      traefik.http.routers.prometheus-router.tls: true
      traefik.http.routers.prometheus-router.tls.certresolver: letsEncrypt
      traefik.http.routers.prometheus-router.service: ${PROMETHEUS_SERVICE_NAME:?}-service
      traefik.http.services.prometheus-service.loadbalancer.server.port: ${PROMETHEUS_SERVICE_PORT:?}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--tries=1", "--spider", "http://localhost:${PROMETHEUS_SERVICE_PORT:?}/"]
      interval: 20s
      timeout: 60s
      start_period: 15s

  grafana:
    image: ${GRAFANA_SERVICE_IMAGE:?}:${GRAFANA_SERVICE_VERSION:?}
    container_name: ${GRAFANA_SERVICE_NAME:?}
    ports:
      - "${GRAFANA_SERVICE_PORT:?}:${GRAFANA_INTERNAL_PORT:?}"
    volumes:
      - "${DOCKER_DATA:?}/${GRAFANA_SERVICE_NAME:?}:/var/lib/grafana"
    security_opt:
      - "label:disable"
    networks:
      - private
    user: "1001"
    labels:
      traefik.enable: true
      traefik.http.routers.grafana-router.entrypoints: https
      traefik.http.routers.grafana-router.rule: Host(`${GRAFANA_SERVICE_NAME:?}.${DOMAIN:?}`)
      traefik.http.routers.grafana-router.tls: true
      traefik.http.routers.grafana-router.tls.certresolver: letsEncrypt
      traefik.http.routers.grafana-router.service: ${GRAFANA_SERVICE_NAME:?}-service
      traefik.http.services.grafana-service.loadbalancer.server.port: ${GRAFANA_INTERNAL_PORT:?}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--tries=1", "--spider", "http://localhost:${GRAFANA_INTERNAL_PORT:?}/"]
      interval: 20s
      timeout: 60s
      start_period: 15s
