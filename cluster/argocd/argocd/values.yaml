---
# https://github.com/argoproj/argo-helm/blob/main/charts/argo-cd/values.yaml
global:
  domain: argocd.wallstreet30.cc

dex:
  enabled: false

server:
  ingress:
    enabled: true
    ingressClassName: traefik
    annotations:
      ingress.kubernetes.io/ssl-redirect: "true"
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      cert-manager.io/cluster-issuer: letsencrypt-production
    hosts:
      - argocd.wallstreet30.cc
    paths:
      - /
    pathType: Prefix
    extraTls:
      - hosts:
          - argocd.wallstreet30.cc
        secretName: argocd-tls

repoServer:
  serviceAccount:
    create: true
    name: argocd-repo-server

  rbac:
    - apiGroups:
        - ""
      resources:
        - secrets
      verbs:
        - get

  volumes:
    - name: custom-tools
      emptyDir: {}
    - name: sops-age
      secret:
        secretName: argocd-age-key
        items:
          - key: keys.txt
            path: keys.txt

  volumeMounts:
    - mountPath: /custom-tools
      name: custom-tools
    - mountPath: /usr/local/bin/kustomize
      name: custom-tools
      subPath: kustomize
    - mountPath: /usr/local/bin/ksops
      name: custom-tools
      subPath: ksops
    - mountPath: /home/argocd/.config/sops/age/keys.txt
      name: sops-age
      subPath: keys.txt
      readOnly: true
    - mountPath: /home/argocd/.config/kustomize/plugin/viaduct.ai/v1/ksops/ksops
      name: custom-tools
      subPath: ksops

  initContainers:
    - name: install-ksops
      image: viaductoss/ksops:v4.3.2
      command: ["/bin/sh", "-c"]
      args:
        - echo "Installing KSOPS..."; mv /usr/local/bin/ksops /custom-tools/; mv /usr/local/bin/kustomize /custom-tools/; echo "Done.";
      volumeMounts:
        - mountPath: /custom-tools
          name: custom-tools

configs:
  params:
    server.insecure: true
  repositories:
    argocd-helm:
      type: helm
      name: argo-cd
      url: https://argoproj.github.io/argo-helm
    bjw-s-helm:
      type: helm
      name: bjw-s
      url: https://bjw-s.github.io/helm-charts
    jetstack:
      type: helm
      name: jetstack
      url: https://charts.jetstack.io
    bitnami:
      type: helm
      name: bitnami
      url: https://charts.bitnami.com/bitnami
    gitea-charts:
      type: helm
      name: gitea-charts
      url: https://dl.gitea.io/charts/
    longhorn:
      type: helm
      name: longhorn
      url: https://charts.longhorn.io
    prometheus:
      type: helm
      name: prometheus
      url: https://prometheus-community.github.io/helm-charts
    grafana:
      type: helm
      name: grafana
      url: https://grafana.github.io/helm-charts
    influxdata:
      type: helm
      name: influxdata
      url: https://helm.influxdata.com/
    cnpg:
      type: helm
      name: cnpg
      url: https://cloudnative-pg.github.io/charts
  secret:
    argocdServerAdminPasswordMtime: "2023-04-23T15:20:00Z"
  cm:
    kustomize.buildOptions: "--enable-alpha-plugins --enable-exec --enable-helm"
    resource.customizations.health.networking.k8s.io_Ingress: |
      hs = {}
      hs.status = "Healthy"
      return hs

controller:
  metrics:
    enabled: true
    applicationLabels:
      enabled: true
    serviceMonitor:
      enabled: true
      # -- Prometheus ServiceMonitor selector
      selector: {}
      # prometheus: kube-prometheus
      # -- Prometheus ServiceMonitor scheme
      scheme: ""
      # -- Prometheus ServiceMonitor tlsConfig
      tlsConfig: {}
      # -- Prometheus ServiceMonitor namespace
      namespace: ""  # "monitoring"
      # -- Prometheus ServiceMonitor labels
      additionalLabels: {}
      # -- Prometheus ServiceMonitor annotations
      annotations: {}
    rules:
      # -- Deploy a PrometheusRule for the application controller
      enabled: true
      namespace: monitoring
      # -- PrometheusRule selector
      selector: {}
      # prometheus: kube-prometheus
      # -- PrometheusRule labels
      additionalLabels: {}
      # -- PrometheusRule annotations
      annotations: {}

      # -- PrometheusRule.Spec for the application controller
      spec: []
      # - alert: ArgoAppMissing
      #   expr: |
      #     absent(argocd_app_info) == 1
      #   for: 15m
      #   labels:
      #     severity: critical
      #   annotations:
      #     summary: "[Argo CD] No reported applications"
      #     description: >
      #       Argo CD has not reported any applications data for the past 15 minutes which
      #       means that it must be down or not functioning properly.  This needs to be
      #       resolved for this cloud to continue to maintain state.
      # - alert: ArgoAppNotSynced
      #   expr: |
      #     argocd_app_info{sync_status!="Synced"} == 1
      #   for: 12h
      #   labels:
      #     severity: warning
      #   annotations:
      #     summary: "[{{`{{$labels.name}}`}}] Application not synchronized"
      #     description: >
      #       The application [{{`{{$labels.name}}`}} has not been synchronized for over
      #       12 hours which means that the state of this cloud has drifted away from the
      #       state inside Git.
