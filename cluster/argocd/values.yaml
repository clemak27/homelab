---
argo-cd:
  dex:
    enabled: false
  server:
    ingress:
      enabled: true
      ingressClassName: traefik
      annotations:
        ingress.kubernetes.io/ssl-redirect: "true"
        traefik.ingress.kubernetes.io/router.entrypoints: websecure
        cert-manager.io/cluster-issuer: letsencrypt-staging
      hosts:
        - argocd.wallstreet30.cc
      paths:
        - /
      pathType: Prefix
      tls:
        - hosts:
            - argocd.wallstreet30.cc
          secretName: argocd-tls

    extraArgs:
      - --insecure

    config:
      kustomize.buildOptions: "--enable-alpha-plugins"
      helm.valuesFileSchemes: >-
        secrets+gpg-import, secrets+gpg-import-kubernetes,
        secrets+age-import, secrets+age-import-kubernetes,
        secrets,secrets+literal,
        https
      resource.customizations.health.networking.k8s.io_Ingress: |
        hs = {}
        hs.status = "Healthy"
        return hs

  repoServer:
    serviceAccount:
      create: true
      name: argocd-repo-server

    rbac:
      - apiGroups:
          - ""
        resources:
          - secrets
        verbs:
          - get

    env:
      - name: HELM_PLUGINS
        value: /custom-tools/helm-plugins/
      - name: HELM_SECRETS_SOPS_PATH
        value: /custom-tools/sops
      - name: HELM_SECRETS_VALS_PATH
        value: /custom-tools/vals
      - name: HELM_SECRETS_KUBECTL_PATH
        value: /custom-tools/kubectl
      - name: HELM_SECRETS_CURL_PATH
        value: /custom-tools/curl
        # https://github.com/jkroepke/helm-secrets/wiki/Security-in-shared-environments
      - name: HELM_SECRETS_VALUES_ALLOW_SYMLINKS
        value: "false"
      - name: HELM_SECRETS_VALUES_ALLOW_ABSOLUTE_PATH
        value: "false"
      - name: HELM_SECRETS_VALUES_ALLOW_PATH_TRAVERSAL
        value: "false"

    volumes:
      - name: custom-tools
        emptyDir: {}

    volumeMounts:
      - mountPath: /custom-tools
        name: custom-tools

    initContainers:
      - name: download-tools
        image: alpine:latest
        command: [sh, -ec]
        env:
          - name: HELM_SECRETS_VERSION
            value: "4.2.2"
          - name: KUBECTL_VERSION
            value: "1.25.0"
          - name: SOPS_VERSION
            value: "3.7.3"
        args:
          - |
            mkdir -p /custom-tools/helm-plugins
            wget -qO- https://github.com/jkroepke/helm-secrets/releases/download/v${HELM_SECRETS_VERSION}/helm-secrets.tar.gz | tar -C /custom-tools/helm-plugins -xzf-;

            # use these on a real server
            # wget -qO /custom-tools/sops https://github.com/mozilla/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux
            # wget -qO /custom-tools/kubectl https://dl.k8s.io/release/v${KUBECTL_VERSION}/bin/linux/amd64/kubectl
            # wget -qO /custom-tools/curl https://github.com/moparisthebest/static-curl/releases/latest/download/curl-amd64 \

            wget -qO /custom-tools/sops https://github.com/mozilla/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux.arm64
            wget -qO /custom-tools/kubectl https://dl.k8s.io/release/v${KUBECTL_VERSION}/bin/linux/arm64/kubectl
            wget -qO /custom-tools/curl https://github.com/moparisthebest/static-curl/releases/latest/download/curl-aarch64  \

            chmod +x /custom-tools/*
        volumeMounts:
          - mountPath: /custom-tools
            name: custom-tools
  configs:
    repositories:
      argocd-helm:
        type: helm
        name: argo-cd
        url: https://argoproj.github.io/argo-helm
      bjw-s-helm:
        type: helm
        name: bjw-s
        url: https://bjw-s.github.io/helm-charts
      jetstack:
        type: helm
        name: jetstack
        url: https://charts.jetstack.io
